<!DOCTYPE html>
<!-- saved from url=(0034)http://documentup.com/kriskowal/q/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8">
<script type="text/javascript" src="./Dokumentation_Projekt_q_files/ef188e7deb"></script><script src="./Dokumentation_Projekt_q_files/nr-686.min.js"></script><script type="text/javascript">window.NREUM||(NREUM={});NREUM.info={"beacon":"bam.nr-data.net","errorBeacon":"bam.nr-data.net","licenseKey":"ef188e7deb","applicationID":"9142077","transactionName":"e1ZWQ0UOXl9QQRxHVEhWS15DDkBaUEAcRllXTg==","queueTime":0,"applicationTime":167,"agent":"js-agent.newrelic.com/nr-686.min.js"}</script>
<script type="text/javascript">window.NREUM||(NREUM={}),__nr_require=function(e,n,t){function r(t){if(!n[t]){var o=n[t]={exports:{}};e[t][0].call(o.exports,function(n){var o=e[t][1][n];return r(o?o:n)},o,o.exports)}return n[t].exports}if("function"==typeof __nr_require)return __nr_require;for(var o=0;o<t.length;o++)r(t[o]);return r}({QJf3ax:[function(e,n){function t(e){function n(n,t,a){e&&e(n,t,a),a||(a={});for(var u=c(n),f=u.length,s=i(a,o,r),p=0;f>p;p++)u[p].apply(s,t);return s}function a(e,n){f[e]=c(e).concat(n)}function c(e){return f[e]||[]}function u(){return t(n)}var f={};return{on:a,emit:n,create:u,listeners:c,_events:f}}function r(){return{}}var o="nr@context",i=e("gos");n.exports=t()},{gos:"7eSDFh"}],ee:[function(e,n){n.exports=e("QJf3ax")},{}],3:[function(e,n){function t(e){return function(){r(e,[(new Date).getTime()].concat(i(arguments)))}}var r=e("handle"),o=e(1),i=e(2);"undefined"==typeof window.newrelic&&(newrelic=window.NREUM);var a=["setPageViewName","addPageAction","setCustomAttribute","finished","addToTrace","inlineHit","noticeError"];o(a,function(e,n){window.NREUM[n]=t("api-"+n)}),n.exports=window.NREUM},{1:12,2:13,handle:"D5DuLP"}],gos:[function(e,n){n.exports=e("7eSDFh")},{}],"7eSDFh":[function(e,n){function t(e,n,t){if(r.call(e,n))return e[n];var o=t();if(Object.defineProperty&&Object.keys)try{return Object.defineProperty(e,n,{value:o,writable:!0,enumerable:!1}),o}catch(i){}return e[n]=o,o}var r=Object.prototype.hasOwnProperty;n.exports=t},{}],D5DuLP:[function(e,n){function t(e,n,t){return r.listeners(e).length?r.emit(e,n,t):void(r.q&&(r.q[e]||(r.q[e]=[]),r.q[e].push(n)))}var r=e("ee").create();n.exports=t,t.ee=r,r.q={}},{ee:"QJf3ax"}],handle:[function(e,n){n.exports=e("D5DuLP")},{}],XL7HBI:[function(e,n){function t(e){var n=typeof e;return!e||"object"!==n&&"function"!==n?-1:e===window?0:i(e,o,function(){return r++})}var r=1,o="nr@id",i=e("gos");n.exports=t},{gos:"7eSDFh"}],id:[function(e,n){n.exports=e("XL7HBI")},{}],G9z0Bl:[function(e,n){function t(){var e=d.info=NREUM.info,n=f.getElementsByTagName("script")[0];if(e&&e.licenseKey&&e.applicationID&&n){c(p,function(n,t){n in e||(e[n]=t)});var t="https"===s.split(":")[0]||e.sslForHttp;d.proto=t?"https://":"http://",a("mark",["onload",i()]);var r=f.createElement("script");r.src=d.proto+e.agent,n.parentNode.insertBefore(r,n)}}function r(){"complete"===f.readyState&&o()}function o(){a("mark",["domContent",i()])}function i(){return(new Date).getTime()}var a=e("handle"),c=e(1),u=window,f=u.document;e(2);var s=(""+location).split("?")[0],p={beacon:"bam.nr-data.net",errorBeacon:"bam.nr-data.net",agent:"js-agent.newrelic.com/nr-686.min.js"},d=n.exports={offset:i(),origin:s,features:{}};f.addEventListener?(f.addEventListener("DOMContentLoaded",o,!1),u.addEventListener("load",t,!1)):(f.attachEvent("onreadystatechange",r),u.attachEvent("onload",t)),a("mark",["firstbyte",i()])},{1:12,2:3,handle:"D5DuLP"}],loader:[function(e,n){n.exports=e("G9z0Bl")},{}],12:[function(e,n){function t(e,n){var t=[],o="",i=0;for(o in e)r.call(e,o)&&(t[i]=n(o,e[o]),i+=1);return t}var r=Object.prototype.hasOwnProperty;n.exports=t},{}],13:[function(e,n){function t(e,n,t){n||(n=0),"undefined"==typeof t&&(t=e?e.length:0);for(var r=-1,o=t-n||0,i=Array(0>o?0:o);++r<o;)i[r]=e[n+r];return i}n.exports=t},{}]},{},["G9z0Bl"]);</script><meta content="yes" name="apple-mobile-web-app-capable"><meta content="width=device-width, initial-scale=1.0" name="viewport"><title>kriskowal/q</title><link href="./Dokumentation_Projekt_q_files/css" rel="stylesheet" type="text/css"><link href="./Dokumentation_Projekt_q_files/application-44e46081aa59859bd1ce7436418eb97c39a54e18a0a011fb0fa8c99f0d067424.css" media="all" rel="stylesheet" type="text/css"><meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="f41+KrQEibVutCYGS0lYMArKjXmmevkkFjmiaoxbVNzWB1gf/6bcfDX07yNg0vgebHf2fOr61119bMZ2TsCcUQ=="><style type="text/css"></style></head><body class="no-literate"><div id="container"><div id="nav"><div id="header"><a href="http://documentup.com/kriskowal/q/#" id="logo">q</a></div><div class="section" id="sections"><ul class="section-nav">
<li class="h2"><a href="http://documentup.com/kriskowal/q/#getting-started">Getting Started</a></li>
<li class="h2"><a href="http://documentup.com/kriskowal/q/#resources">Resources</a></li>
<li class="h2"><a href="http://documentup.com/kriskowal/q/#tutorial">Tutorial</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#propagation">Propagation</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#chaining">Chaining</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#combination">Combination</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#sequences">Sequences</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#handling-errors">Handling Errors</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#progress-notification">Progress Notification</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#the-end">The End</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#the-beginning">The Beginning</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#the-middle">The Middle</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#over-the-wire">Over the Wire</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#adapting-node">Adapting Node</a></li>
<li class="h3"><a href="http://documentup.com/kriskowal/q/#long-stack-traces">Long Stack Traces</a></li>
<li class="h2"><a href="http://documentup.com/kriskowal/q/#tests">Tests</a></li>
<li class="h2"><a href="http://documentup.com/kriskowal/q/#license">License</a></li>
</ul></div><div class="extra section" id="github"><a href="https://github.com/kriskowal/q">Source on Github</a></div><div class="extra section" id="github-issues"><a href="https://github.com/kriskowal/q/issues">Issues</a></div></div><div id="content"><a href="https://github.com/kriskowal/q" id="github-ribbon"><img alt="Fork me on GitHub" src="./Dokumentation_Projekt_q_files/forkme_right_darkblue_121621.png"></a><p><a href="http://travis-ci.org/kriskowal/q"><img src="./Dokumentation_Projekt_q_files/q.png" alt="Build Status" style="max-width:100%;"></a></p>

<p><a href="http://promises-aplus.github.com/promises-spec"><br>
    <img src="./Dokumentation_Projekt_q_files/q(1).png" style="max-width:100%;">
         align="right" alt="Q logo" /&gt;<br>
</a></p>

<p><em>This is Q version 1, from the <code>v1</code> branch in Git. This documentation applies to<br>
the latest of both the version 1 and version 0.9 release trains. These releases<br>
are stable. There will be no further releases of 0.9 after 0.9.7 which is nearly<br>
equivalent to version 1.0.0. All further releases of <code>q@~1.0</code> will be backward<br>
compatible. The version 2 release train introduces significant and<br>
backward-incompatible changes and is experimental at this time.</em></p>

<p>If a function cannot return a value or throw an exception without<br>
blocking, it can return a promise instead.  A promise is an object<br>
that represents the return value or the thrown exception that the<br>
function may eventually provide.  A promise can also be used as a<br>
proxy for a <a href="https://github.com/kriskowal/q-connection">remote object</a> to overcome latency.</p>

<p>On the first pass, promises can mitigate the “<a href="http://calculist.org/blog/2011/12/14/why-coroutines-wont-work-on-the-web/">Pyramid of<br>
Doom</a>”: the situation where code marches to the right faster<br>
than it marches forward.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">step1</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step2</span><span class="p">(</span><span class="nx">value1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">step3</span><span class="p">(</span><span class="nx">value2</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">step4</span><span class="p">(</span><span class="nx">value3</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value4</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Do something with value4</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>With a promise library, you can flatten the pyramid.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="nx">promisedStep1</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">promisedStep2</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">promisedStep3</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">promisedStep4</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value4</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Do something with value4</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Handle any error from all above steps</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">done</span><span class="p">();</span>
</pre></div>

<p>With this approach, you also get implicit error propagation, just like <code>try</code>,<br>
<code>catch</code>, and <code>finally</code>.  An error in <code>promisedStep1</code> will flow all the way to<br>
the <code>catch</code> function, where it’s caught and handled.  (Here <code>promisedStepN</code> is<br>
a version of <code>stepN</code> that returns a promise.)</p>

<p>The callback approach is called an “inversion of control”.<br>
A function that accepts a callback instead of a return value<br>
is saying, “Don’t call me, I’ll call you.”.  Promises<br>
<a href="http://www.slideshare.net/domenicdenicola/callbacks-promises-and-coroutines-oh-my-the-evolution-of-asynchronicity-in-javascript">un-invert</a> the inversion, cleanly separating the input<br>
arguments from control flow arguments.  This simplifies the<br>
use and creation of API’s, particularly variadic,<br>
rest and spread arguments.</p>

<h2>
<a id="getting-started" class="anchor" href="http://documentup.com/kriskowal/q/#getting-started" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting Started</h2>

<p>The Q module can be loaded as:</p>

<ul>
<li>  A <code>&lt;script&gt;</code> tag (creating a <code>Q</code> global variable): ~2.5 KB minified and
gzipped.</li>
<li>  A Node.js and CommonJS module, available in <a href="https://npmjs.org/">npm</a> as
the <a href="https://npmjs.org/package/q">q</a> package</li>
<li>  An AMD module</li>
<li>  A <a href="https://github.com/component/component">component</a> as <code>microjs/q</code>
</li>
<li>  Using <a href="http://bower.io/">bower</a> as <code>q#1.0.1</code>
</li>
<li>  Using <a href="http://nuget.org/">NuGet</a> as <a href="https://nuget.org/packages/q">Q</a>
</li>
</ul>

<p>Q can exchange promises with jQuery, Dojo, When.js, WinJS, and more.</p>

<h2>
<a id="resources" class="anchor" href="http://documentup.com/kriskowal/q/#resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Resources</h2>

<p>Our <a href="https://github.com/kriskowal/q/wiki">wiki</a> contains a number of useful resources, including:</p>

<ul>
<li>A method-by-method <a href="https://github.com/kriskowal/q/wiki/API-Reference">Q API reference</a>.</li>
<li>A growing <a href="https://github.com/kriskowal/q/wiki/Examples-Gallery">examples gallery</a>, showing how Q can be used to make
everything better. From XHR to database access to accessing the Flickr API,
Q is there for you.</li>
<li>There are many libraries that produce and consume Q promises for everything
from file system/database access or RPC to templating. For a list of some of
the more popular ones, see <a href="https://github.com/kriskowal/q/wiki/Libraries">Libraries</a>.</li>
<li>If you want materials that introduce the promise concept generally, and the
below tutorial isn't doing it for you, check out our collection of
<a href="https://github.com/kriskowal/q/wiki/General-Promise-Resources">presentations, blog posts, and podcasts</a>.</li>
<li>A guide for those <a href="https://github.com/kriskowal/q/wiki/Coming-from-jQuery">coming from jQuery's <code>$.Deferred</code></a>.</li>
</ul>

<p>We'd also love to have you join the Q-Continuum <a href="https://groups.google.com/forum/#!forum/q-continuum">mailing list</a>.</p>

<h2>
<a id="tutorial" class="anchor" href="http://documentup.com/kriskowal/q/#tutorial" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tutorial</h2>

<p>Promises have a <code>then</code> method, which you can use to get the eventual<br>
return value (fulfillment) or thrown exception (rejection).</p>

<div class="highlight highlight-javascript"><pre><span class="nx">promiseMeSomething</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<p>If <code>promiseMeSomething</code> returns a promise that gets fulfilled later<br>
with a return value, the first function (the fulfillment handler) will be<br>
called with the value.  However, if the <code>promiseMeSomething</code> function<br>
gets rejected later by a thrown exception, the second function (the<br>
rejection handler) will be called with the exception.</p>

<p>Note that resolution of a promise is always asynchronous: that is, the<br>
fulfillment or rejection handler will always be called in the next turn of the<br>
event loop (i.e. <code>process.nextTick</code> in Node). This gives you a nice<br>
guarantee when mentally tracing the flow of your code, namely that<br>
<code>then</code> will always return before either handler is executed.</p>

<p>In this tutorial, we begin with how to consume and work with promises. We'll<br>
talk about how to create them, and thus create functions like<br>
<code>promiseMeSomething</code> that return promises, <a href="http://documentup.com/kriskowal/q/#the-beginning">below</a>.</p>

<h3>
<a id="propagation" class="anchor" href="http://documentup.com/kriskowal/q/#propagation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Propagation</h3>

<p>The <code>then</code> method returns a promise, which in this example, I’m<br>
assigning to <code>outputPromise</code>.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<p>The <code>outputPromise</code> variable becomes a new promise for the return<br>
value of either handler.  Since a function can only either return a<br>
value or throw an exception, only one handler will ever be called and it<br>
will be responsible for resolving <code>outputPromise</code>.</p>

<ul>
<li><p>If you return a value in a handler, <code>outputPromise</code> will get<br>
fulfilled.</p></li>
<li><p>If you throw an exception in a handler, <code>outputPromise</code> will get<br>
rejected.</p></li>
<li><p>If you return a <strong>promise</strong> in a handler, <code>outputPromise</code> will<br>
“become” that promise.  Being able to become a new promise is useful<br>
for managing delays, combining results, or recovering from errors.</p></li>
</ul>

<p>If the <code>getInputPromise()</code> promise gets rejected and you omit the<br>
rejection handler, the <strong>error</strong> will go to <code>outputPromise</code>:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<p>If the input promise gets fulfilled and you omit the fulfillment handler, the<br>
<strong>value</strong> will go to <code>outputPromise</code>:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<p>Q promises provide a <code>fail</code> shorthand for <code>then</code> when you are only<br>
interested in handling the error:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<p>If you are writing JavaScript for modern engines only or using<br>
CoffeeScript, you may use <code>catch</code> instead of <code>fail</code>.</p>

<p>Promises also have a <code>fin</code> function that is like a <code>finally</code> clause.<br>
The final handler gets called, with no arguments, when the promise<br>
returned by <code>getInputPromise()</code> either returns a value or throws an<br>
error.  The value returned or error thrown by <code>getInputPromise()</code><br>
passes directly to <code>outputPromise</code> unless the final handler fails, and<br>
may be delayed if the final handler returns a promise.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">fin</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// close files, database connections, stop servers, conclude tests</span>
<span class="p">});</span>
</pre></div>

<ul>
<li>  If the handler returns a value, the value is ignored</li>
<li>  If the handler throws an error, the error passes to <code>outputPromise</code>
</li>
<li>  If the handler returns a promise, <code>outputPromise</code> gets postponed.  The
eventual value or error has the same effect as an immediate return
value or thrown error: a value would be ignored, an error would be
forwarded.</li>
</ul>

<p>If you are writing JavaScript for modern engines only or using<br>
CoffeeScript, you may use <code>finally</code> instead of <code>fin</code>.</p>

<h3>
<a id="chaining" class="anchor" href="http://documentup.com/kriskowal/q/#chaining" aria-hidden="true"><span class="octicon octicon-link"></span></a>Chaining</h3>

<p>There are two ways to chain promises.  You can chain promises either<br>
inside or outside handlers.  The next two examples are equivalent.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">getUsername</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// if we get here without an error,</span>
        <span class="c1">// the value returned here</span>
        <span class="c1">// or the exception thrown here</span>
        <span class="c1">// resolves the promise returned</span>
        <span class="c1">// by the first line</span>
    <span class="p">})</span>
<span class="p">});</span>
</pre></div>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">getUsername</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if we get here without an error,</span>
    <span class="c1">// the value returned here</span>
    <span class="c1">// or the exception thrown here</span>
    <span class="c1">// resolves the promise returned</span>
    <span class="c1">// by the first line</span>
<span class="p">});</span>
</pre></div>

<p>The only difference is nesting.  It’s useful to nest handlers if you<br>
need to capture multiple input values in your closure.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">authenticate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">getUsername</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="c1">// chained because we will not need the user name in the next event</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPassword</span><span class="p">()</span>
        <span class="c1">// nested because we need both user and password next</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">passwordHash</span> <span class="o">!==</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Can't authenticate"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

<h3>
<a id="combination" class="anchor" href="http://documentup.com/kriskowal/q/#combination" aria-hidden="true"><span class="octicon octicon-link"></span></a>Combination</h3>

<p>You can turn an array of promises into a promise for the whole,<br>
fulfilled array using <code>all</code>.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">eventualAdd</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="nx">eventualAdd</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="p">]);</span>
</pre></div>

<p>If you have a promise for an array, you can use <code>spread</code> as a<br>
replacement for <code>then</code>.  The <code>spread</code> function “spreads” the<br>
values over the arguments of the fulfillment handler.  The rejection handler<br>
will get called at the first sign of failure.  That is, whichever of<br>
the received promises fails first gets handled by the rejection handler.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">eventualAdd</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">spread</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>

<p>But <code>spread</code> calls <code>all</code> initially, so you can skip it in chains.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">getUsername</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">)];</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<p>The <code>all</code> function returns a promise for an array of values.  When this<br>
promise is fulfilled, the array contains the fulfillment values of the original<br>
promises, in the same order as those promises.  If one of the given promises<br>
is rejected, the returned promise is immediately rejected, not waiting for the<br>
rest of the batch.  If you want to wait for all of the promises to either be<br>
fulfilled or rejected, you can use <code>allSettled</code>.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">Q</span><span class="p">.</span><span class="nx">allSettled</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="s2">"fulfilled"</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">reason</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">reason</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>

<p>The <code>any</code> function accepts an array of promises and returns a promise that is<br>
fulfilled by the first given promise to be fulfilled, or rejected if all of the<br>
given promises are rejected.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">Q</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">first</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Any of the promises was fulfilled.</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// All of the promises were rejected.</span>
<span class="p">});</span>
</pre></div>

<h3>
<a id="sequences" class="anchor" href="http://documentup.com/kriskowal/q/#sequences" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sequences</h3>

<p>If you have a number of promise-producing functions that need<br>
to be run sequentially, you can of course do so manually:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">foo</span><span class="p">(</span><span class="nx">initialVal</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">bar</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">baz</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">qux</span><span class="p">);</span>
</pre></div>

<p>However, if you want to run a dynamically constructed sequence of<br>
functions, you'll want something like this:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">,</span> <span class="nx">qux</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">initialVal</span><span class="p">);</span>
<span class="nx">funcs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
<span class="p">});</span>
<span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</pre></div>

<p>You can make this slightly more compact using <code>reduce</code>:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">funcs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">soFar</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">soFar</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
<span class="p">},</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">initialVal</span><span class="p">));</span>
</pre></div>

<p>Or, you could use the ultra-compact version:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">funcs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">when</span><span class="p">,</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">initialVal</span><span class="p">));</span>
</pre></div>

<h3>
<a id="handling-errors" class="anchor" href="http://documentup.com/kriskowal/q/#handling-errors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Handling Errors</h3>

<p>One sometimes-unintuive aspect of promises is that if you throw an<br>
exception in the fulfillment handler, it will not be caught by the error<br>
handler.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">foo</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Can't bar."</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We only get here if "foo" fails</span>
<span class="p">});</span>
</pre></div>

<p>To see why this is, consider the parallel between promises and<br>
<code>try</code>/<code>catch</code>. We are <code>try</code>-ing to execute <code>foo()</code>: the error<br>
handler represents a <code>catch</code> for <code>foo()</code>, while the fulfillment handler<br>
represents code that happens <em>after</em> the <code>try</code>/<code>catch</code> block.<br>
That code then needs its own <code>try</code>/<code>catch</code> block.</p>

<p>In terms of promises, this means chaining your rejection handler:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">foo</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Can't bar."</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We get here with either foo's error or bar's error</span>
<span class="p">});</span>
</pre></div>

<h3>
<a id="progress-notification" class="anchor" href="http://documentup.com/kriskowal/q/#progress-notification" aria-hidden="true"><span class="octicon octicon-link"></span></a>Progress Notification</h3>

<p>It's possible for promises to report their progress, e.g. for tasks that take a<br>
long time like a file upload. Not all promises will implement progress<br>
notifications, but for those that do, you can consume the progress values using<br>
a third parameter to <code>then</code>:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">uploadFile</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Success uploading the file</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// There was an error, and we get the reason for error</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We get notified of the upload's progress as it is executed</span>
<span class="p">});</span>
</pre></div>

<p>Like <code>fail</code>, Q also provides a shorthand for progress callbacks<br>
called <code>progress</code>:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">uploadFile</span><span class="p">().</span><span class="nx">progress</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We get notified of the upload's progress</span>
<span class="p">});</span>
</pre></div>

<h3>
<a id="the-end" class="anchor" href="http://documentup.com/kriskowal/q/#the-end" aria-hidden="true"><span class="octicon octicon-link"></span></a>The End</h3>

<p>When you get to the end of a chain of promises, you should either<br>
return the last promise or end the chain.  Since handlers catch<br>
errors, it’s an unfortunate pattern that the exceptions can go<br>
unobserved.</p>

<p>So, either return it,</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">foo</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">"bar"</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>

<p>Or, end it.</p>

<div class="highlight highlight-javascript"><pre><span class="nx">foo</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">"bar"</span><span class="p">;</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">done</span><span class="p">();</span>
</pre></div>

<p>Ending a promise chain makes sure that, if an error doesn’t get<br>
handled before the end, it will get rethrown and reported.</p>

<p>This is a stopgap. We are exploring ways to make unhandled errors<br>
visible without any explicit handling.</p>

<h3>
<a id="the-beginning" class="anchor" href="http://documentup.com/kriskowal/q/#the-beginning" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Beginning</h3>

<p>Everything above assumes you get a promise from somewhere else.  This<br>
is the common case.  Every once in a while, you will need to create a<br>
promise from scratch.</p>

<h4>Using <code>Q.fcall</code>
</h4>

<p>You can create a promise from a value using <code>Q.fcall</code>.  This returns a<br>
promise for 10.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>

<p>You can also use <code>fcall</code> to get a promise for an exception.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Can't do it"</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>As the name implies, <code>fcall</code> can call functions, or even promised<br>
functions.  This uses the <code>eventualAdd</code> function above to add two<br>
numbers.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="nx">eventualAdd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</pre></div>

<h4>Using Deferreds</h4>

<p>If you have to interface with asynchronous functions that are callback-based<br>
instead of promise-based, Q provides a few shortcuts (like <code>Q.nfcall</code> and<br>
friends). But much of the time, the solution will be to use <em>deferreds</em>.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
<span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"foo.txt"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
</pre></div>

<p>Note that a deferred can be resolved with a value or a promise.  The<br>
<code>reject</code> function is a shorthand for resolving with a rejected<br>
promise.</p>

<div class="highlight highlight-javascript"><pre><span class="c1">// this:</span>
<span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Can't do it"</span><span class="p">));</span>

<span class="c1">// is shorthand for:</span>
<span class="kd">var</span> <span class="nx">rejection</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Can't do it"</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">rejection</span><span class="p">);</span>
</pre></div>

<p>This is a simplified implementation of <code>Q.delay</code>.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">delay</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>This is a simplified implementation of <code>Q.timeout</code></p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">timeout</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="nx">Q</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">);</span>
    <span class="nx">delay</span><span class="p">(</span><span class="nx">ms</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Timed out"</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Finally, you can send a progress notification to the promise with<br>
<code>deferred.notify</code>.</p>

<p>For illustration, this is a wrapper for XML HTTP requests in the browser. Note<br>
that a more <a href="https://github.com/montagejs/mr/blob/71e8df99bb4f0584985accd6f2801ef3015b9763/browser.js#L29-L73">thorough</a> implementation would be in order in practice.</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">requestOkText</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">onload</span><span class="p">;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">onerror</span><span class="p">;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="nx">onprogress</span><span class="p">;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">onload</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Status code was "</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onerror</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Can't XHR "</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">url</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onprogress</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">event</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>Below is an example of how to use this <code>requestOkText</code> function:</p>

<div class="highlight highlight-javascript"><pre><span class="nx">requestOkText</span><span class="p">(</span><span class="s2">"http://localhost:3000"</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">responseText</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If the HTTP response returns 200 OK, log the response text.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">responseText</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If there's an error or a non-200 status code, log the error.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Log the progress as it comes in.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Request progress: "</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">progress</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"%"</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<h4>Using <code>Q.Promise</code>
</h4>

<p>This is an alternative promise-creation API that has the same power as<br>
the deferred concept, but without introducing another conceptual entity.</p>

<p>Rewriting the <code>requestOkText</code> example above using <code>Q.Promise</code>:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">function</span> <span class="nx">requestOkText</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">,</span> <span class="nx">notify</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>

        <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">onload</span><span class="p">;</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">onerror</span><span class="p">;</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="nx">onprogress</span><span class="p">;</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>

        <span class="kd">function</span> <span class="nx">onload</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Status code was "</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">onerror</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"Can't XHR "</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">url</span><span class="p">)));</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">onprogress</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">notify</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">event</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

<p>If <code>requestOkText</code> were to throw an exception, the returned promise would be<br>
rejected with that thrown exception as the rejection reason.</p>

<h3>
<a id="the-middle" class="anchor" href="http://documentup.com/kriskowal/q/#the-middle" aria-hidden="true"><span class="octicon octicon-link"></span></a>The Middle</h3>

<p>If you are using a function that may return a promise, but just might<br>
return a value if it doesn’t need to defer, you can use the “static”<br>
methods of the Q library.</p>

<p>The <code>when</code> function is the static equivalent for <code>then</code>.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">valueOrPromise</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<p>All of the other methods on a promise have static analogs with the<br>
same name.</p>

<p>The following are equivalent:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">]);</span>
</pre></div>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">];</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">all</span><span class="p">();</span>
</pre></div>

<p>When working with promises provided by other libraries, you should<br>
convert it to a Q promise.  Not all promise libraries make the same<br>
guarantees as Q and certainly don’t provide all of the same methods.<br>
Most libraries only provide a partially functional <code>then</code> method.<br>
This thankfully is all we need to turn them into vibrant Q promises.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(...))</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<p>If there is any chance that the promise you receive is not a Q promise<br>
as provided by your library, you should wrap it using a Q function.<br>
You can even use <code>Q.invoke</code> as a shorthand.</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="s1">'ajax'</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>

<h3>
<a id="over-the-wire" class="anchor" href="http://documentup.com/kriskowal/q/#over-the-wire" aria-hidden="true"><span class="octicon octicon-link"></span></a>Over the Wire</h3>

<p>A promise can serve as a proxy for another object, even a remote<br>
object.  There are methods that allow you to optimistically manipulate<br>
properties or call functions.  All of these interactions return<br>
promises, so they can be chained.</p>

<pre><code>direct manipulation         using a promise as a proxy
--------------------------  -------------------------------
value.foo                   promise.get("foo")
value.foo = value           promise.put("foo", value)
delete value.foo            promise.del("foo")
value.foo(...args)          promise.post("foo", [args])
value.foo(...args)          promise.invoke("foo", ...args)
value(...args)              promise.fapply([args])
value(...args)              promise.fcall(...args)
</code></pre>

<p>If the promise is a proxy for a remote object, you can shave<br>
round-trips by using these functions instead of <code>then</code>.  To take<br>
advantage of promises for remote objects, check out <a href="https://github.com/kriskowal/q-connection">Q-Connection</a>.</p>

<p>Even in the case of non-remote objects, these methods can be used as<br>
shorthand for particularly-simple fulfillment handlers. For example, you<br>
can replace</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">"bar"</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">"baz"</span> <span class="p">}];</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>

<p>with</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">"bar"</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">"baz"</span> <span class="p">}];</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">);</span>
</pre></div>

<h3>
<a id="adapting-node" class="anchor" href="http://documentup.com/kriskowal/q/#adapting-node" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adapting Node</h3>

<p>If you're working with functions that make use of the Node.js callback pattern,<br>
where callbacks are in the form of <code>function(err, result)</code>, Q provides a few<br>
useful utility functions for converting between them. The most straightforward<br>
are probably <code>Q.nfcall</code> and <code>Q.nfapply</code> ("Node function call/apply") for calling<br>
Node.js-style functions and getting back a promise:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span><span class="p">(</span><span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">,</span> <span class="s2">"foo.txt"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">nfapply</span><span class="p">(</span><span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">,</span> <span class="p">[</span><span class="s2">"foo.txt"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">]);</span>
</pre></div>

<p>If you are working with methods, instead of simple functions, you can easily<br>
run in to the usual problems where passing a method to another function—like<br>
<code>Q.nfcall</code>—"un-binds" the method from its owner. To avoid this, you can either<br>
use <code>Function.prototype.bind</code> or some nice shortcut methods we provide:</p>

<div class="highlight highlight-javascript"><pre><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">ninvoke</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="s2">"user:1:id"</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">npost</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span> <span class="s2">"get"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"user:1:id"</span><span class="p">]);</span>
</pre></div>

<p>You can also create reusable wrappers with <code>Q.denodeify</code> or <code>Q.nbind</code>:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">readFile</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">denodeify</span><span class="p">(</span><span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">readFile</span><span class="p">(</span><span class="s2">"foo.txt"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">redisClientGet</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">nbind</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">.</span><span class="nx">get</span><span class="p">,</span> <span class="nx">redisClient</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">redisClientGet</span><span class="p">(</span><span class="s2">"user:1:id"</span><span class="p">);</span>
</pre></div>

<p>Finally, if you're working with raw deferred objects, there is a<br>
<code>makeNodeResolver</code> method on deferreds that can be handy:</p>

<div class="highlight highlight-javascript"><pre><span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
<span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">"foo.txt"</span><span class="p">,</span> <span class="s2">"utf-8"</span><span class="p">,</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">makeNodeResolver</span><span class="p">());</span>
<span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
</pre></div>

<h3>
<a id="long-stack-traces" class="anchor" href="http://documentup.com/kriskowal/q/#long-stack-traces" aria-hidden="true"><span class="octicon octicon-link"></span></a>Long Stack Traces</h3>

<p>Q comes with optional support for “long stack traces,” wherein the <code>stack</code><br>
property of <code>Error</code> rejection reasons is rewritten to be traced along<br>
asynchronous jumps instead of stopping at the most recent one. As an example:</p>

<div class="highlight highlight-js"><pre><span class="kd">function</span> <span class="nx">theDepthsOfMyProgram</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="nx">explode</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">"boo!"</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">theDepthsOfMyProgram</span><span class="p">();</span>
</pre></div>

<p>usually would give a rather unhelpful stack trace looking something like</p>

<pre><code>Error: boo!
    at explode (/path/to/test.js:3:11)
    at _fulfilled (/path/to/test.js:q:54)
    at resolvedValue.promiseDispatch.done (/path/to/q.js:823:30)
    at makePromise.promise.promiseDispatch (/path/to/q.js:496:13)
    at pending (/path/to/q.js:397:39)
    at process.startup.processNextTick.process._tickCallback (node.js:244:9)
</code></pre>

<p>But, if you turn this feature on by setting</p>

<div class="highlight highlight-js"><pre><span class="nx">Q</span><span class="p">.</span><span class="nx">longStackSupport</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</pre></div>

<p>then the above code gives a nice stack trace to the tune of</p>

<pre><code>Error: boo!
    at explode (/path/to/test.js:3:11)
From previous event:
    at theDepthsOfMyProgram (/path/to/test.js:2:16)
    at Object.&lt;anonymous&gt; (/path/to/test.js:7:1)
</code></pre>

<p>Note how you can see the function that triggered the async operation in the<br>
stack trace! This is very helpful for debugging, as otherwise you end up getting<br>
only the first line, plus a bunch of Q internals, with no sign of where the<br>
operation started.</p>

<p>In node.js, this feature can also be enabled through the Q_DEBUG environment<br>
variable:</p>

<pre><code>Q_DEBUG=1 node server.js
</code></pre>

<p>This will enable long stack support in every instance of Q.</p>

<p>This feature does come with somewhat-serious performance and memory overhead,<br>
however. If you're working with lots of promises, or trying to scale a server<br>
to many users, you should probably keep it off. But in development, go for it!</p>

<h2>
<a id="tests" class="anchor" href="http://documentup.com/kriskowal/q/#tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tests</h2>

<p>You can view the results of the Q test suite <a href="https://rawgithub.com/kriskowal/q/v1/spec/q-spec.html">in your browser</a>!</p>

<h2>
<a id="license" class="anchor" href="http://documentup.com/kriskowal/q/#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Copyright 2009–2015 Kristopher Michael Kowal and contributors<br>
MIT License (enclosed)</p></div></div></body></html>